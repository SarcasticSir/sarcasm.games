<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8">
Â  <title>Simple Tier List</title>
Â  <style>
Â  Â  /*
Â  Â  Â  Simple style sheet for a local tier list.

Â  Â  Â  Tiers consist of a colored header and an area where items
Â  Â  Â  can be moved around with drag-and-drop. The colors and names can
Â  Â  Â  be changed for each tier, and new items can be added via the controls
Â  Â  Â  at the top. Finally, the layout can be saved to the browser's localStorage.
Â  Â  */
Â  Â  :root {
Â  Â  Â  /* Tier header width. Adjusted to make the boxes a bit narrower */
Â  Â  Â  --header-width: 110px;
Â  Â  Â  --tier-gap: 8px;
Â  Â  Â  /* Color variables for light mode */
Â  Â  Â  --background: #f8f9fa;
Â  Â  Â  --foreground: #333333;
Â  Â  Â  --item-bg: #ffffff;
Â  Â  Â  --tier-items-bg: #fafafa;
Â  Â  Â  --control-bg: #007bff;
Â  Â  Â  --control-hover-bg: #0056b3;
Â  Â  Â  --button-text-color: #ffffff;
Â  Â  }

Â  Â  /* When data-theme=dark is set on documentElement (html), the variables for dark mode are overridden */
Â  Â  [data-theme="dark"] {
Â  Â  Â  --background: #121212;
Â  Â  Â  --foreground: #e0e0e0;
Â  Â  Â  --item-bg: #1e1e1e;
Â  Â  Â  --tier-items-bg: #2a2a2a;
Â  Â  Â  --control-bg: #0d6efd;
Â  Â  Â  --control-hover-bg: #0a58ca;
Â  Â  Â  --button-text-color: #ffffff;
Â  Â  }

Â  Â  body {
Â  Â  Â  font-family: Arial, sans-serif;
Â  Â  Â  background-color: var(--background);
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 20px;
Â  Â  Â  color: var(--foreground);
Â  Â  }

Â  Â  h1 {
Â  Â  Â  text-align: center;
Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  color: var(--foreground);
Â  Â  }

Â  Â  /* Allow editing of page title without showing an ugly border.
Â  Â  Â  Â  Instead, show a discrete dashed border when the field is in focus. */
Â  Â  #pageTitle[contenteditable] {
Â  Â  Â  border: none;
Â  Â  Â  outline: none;
Â  Â  Â  cursor: text;
Â  Â  Â  display: inline-block;
Â  Â  Â  padding: 2px 4px;
Â  Â  Â  border-radius: 4px;
Â  Â  }
Â  Â  #pageTitle[contenteditable]:focus {
Â  Â  Â  outline: 2px dashed #007bff;
Â  Â  }

Â  Â  .container {
Â  Â  Â  max-width: 900px;
Â  Â  Â  margin: 0 auto;
Â  Â  }

Â  Â  .controls {
Â  Â  Â  display: flex;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  gap: 10px;
Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  align-items: center;
Â  Â  }

Â  Â  .controls input[type="text"] {
Â  Â  Â  flex-grow: 1;
Â  Â  Â  padding: 8px 10px;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  border-radius: 4px;
Â  Â  }

Â  Â  .controls button {
Â  Â  Â  padding: 8px 12px;
Â  Â  Â  border: none;
Â  Â  Â  background-color: var(--control-bg);
Â  Â  Â  color: var(--button-text-color);
Â  Â  Â  border-radius: 4px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: background-color 0.2s ease;
Â  Â  }

Â  Â  .controls button:hover {
Â  Â  Â  background-color: var(--control-hover-bg);
Â  Â  }

Â  Â  /* Special styling for the theme toggle button to make it small and distinct. */
Â  Â  #themeToggle {
Â  Â  Â  width: 2.1rem;
Â  Â  Â  height: 2.1rem;
Â  Â  Â  padding: 0;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  font-size: 1.1rem;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  background-color: transparent;
Â  Â  Â  border: 2px solid var(--control-bg);
Â  Â  Â  color: var(--control-bg);
Â  Â  Â  margin-left: auto;
Â  Â  }
Â  Â  #themeToggle:hover {
Â  Â  Â  background-color: var(--control-bg);
Â  Â  Â  color: var(--button-text-color);
Â  Â  }

Â  Â  /* Tier layout */
Â  Â  .tier {
Â  Â  Â  display: flex;
Â  Â  Â  border: 1px solid #ddd;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  overflow: hidden;
Â  Â  Â  margin-bottom: var(--tier-gap);
Â  Â  Â  background-color: #fff;
Â  Â  }

Â  Â  .tier-header {
Â  Â  Â  width: var(--header-width);
Â  Â  Â  padding: 5px;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  gap: 3px;
Â  Â  Â  box-sizing: border-box;
Â  Â  }

Â  Â  .tier-header input[type="text"] {
Â  Â  Â  width: 100%;
Â  Â  Â  border: none;
Â  Â  Â  font-weight: bold;
Â  Â  Â  font-size: 1rem;
Â  Â  Â  background-color: transparent;
Â  Â  Â  padding: 4px;
Â  Â  Â  outline: none;
Â  Â  Â  /* allow automatic line breaks for long category names */
Â  Â  Â  white-space: normal;
Â  Â  Â  overflow-wrap: anywhere;
Â  Â  Â  /* inherit color from the header for good contrast */
Â  Â  Â  color: inherit;
Â  Â  }

Â  Â  /* Progress bar inside the tier header */
Â  Â  .progress-container {
Â  Â  Â  width: 100%;
Â  Â  Â  height: 6px;
Â  Â  Â  background-color: rgba(255, 255, 255, 0.3);
Â  Â  Â  border-radius: 3px;
Â  Â  Â  overflow: hidden;
Â  Â  }
Â  Â  .progress-bar {
Â  Â  Â  height: 100%;
Â  Â  Â  width: 0%;
Â  Â  Â  background-color: currentColor;
Â  Â  }

Â  Â  /* Footer with count, percentage, color picker and remove button */
Â  Â  .tier-footer {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 4px;
Â  Â  Â  font-size: 0.8rem;
Â  Â  }
Â  Â  /* Specific classes to easily find count and percentage in JS */
Â  Â  .count-info {
Â  Â  Â  /* no specific styles yet */
Â  Â  }
Â  Â  .percent-info {
Â  Â  Â  /* no specific styles yet */
Â  Â  }

Â  Â  /* Trash bin for removing items */
Â  Â  #trashBin {
Â  Â  Â  width: 100px;
Â  Â  Â  height: 50px;
Â  Â  Â  border: 2px dashed #999;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  font-size: 1rem;
Â  Â  Â  margin-top: 10px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  color: var(--foreground);
Â  Â  Â  background-color: var(--tier-items-bg);
Â  Â  Â  transition: background-color 0.2s ease, border-color 0.2s ease;
Â  Â  }
Â  Â  #trashBin.drag-over {
Â  Â  Â  background-color: #ffe6e6;
Â  Â  Â  border-color: #ff6b6b;
Â  Â  }
Â  Â  .tier-footer input[type="color"] {
Â  Â  Â  width: 1.3rem;
Â  Â  Â  height: 1.3rem;
Â  Â  Â  border: none;
Â  Â  Â  padding: 0;
Â  Â  Â  cursor: pointer;
Â  Â  }

Â  Â  .tier-items {
Â  Â  Â  flex-grow: 1;
Â  Â  Â  /* Reduce min-height so boxes don't get so tall */
Â  Â  Â  min-height: 50px;
Â  Â  Â  padding: 8px;
Â  Â  Â  display: flex;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  align-items: flex-start;
Â  Â  Â  gap: 8px;
Â  Â  Â  background-color: var(--tier-items-bg);
Â  Â  Â  transition: background-color 0.2s ease;
Â  Â  }

Â  Â  .tier-items.drag-over {
Â  Â  Â  background-color: #e6f7ff;
Â  Â  Â  border: 2px dashed #007bff;
Â  Â  }

Â  Â  .item {
Â  Â  Â  padding: 6px 10px;
Â  Â  Â  background-color: var(--item-bg);
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  cursor: move;
Â  Â  Â  user-select: none;
Â  Â  Â  font-size: 0.85rem;
Â  Â  Â  /* allow line wraps when extra fields are shown */
Â  Â  Â  white-space: normal;
Â  Â  Â  /* Stack rows for text and extra fields */
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  align-items: flex-start;
Â  Â  Â  color: var(--foreground);
Â  Â  }

Â  Â  .item.dragging {
Â  Â  Â  opacity: 0.6;
Â  Â  }

Â  Â  /* Small extra fields that are permanently displayed on the items */
Â  Â  .extra-fields {
Â  Â  Â  font-size: 0.7rem;
Â  Â  Â  opacity: 0.8;
Â  Â  Â  margin-top: 2px;
Â  Â  Â  color: var(--foreground);
Â  Â  }

Â  Â  /* Settings panel for column view */
Â  Â  #settingsOverlay {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  background-color: rgba(0, 0, 0, 0.5);
Â  Â  Â  z-index: 1000;
Â  Â  Â  display: none;
Â  Â  }

Â  Â  #settingsPanel {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 50%;
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translate(-50%, -50%);
Â  Â  Â  background-color: var(--item-bg);
Â  Â  Â  color: var(--foreground);
Â  Â  Â  border: 2px solid #ccc;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  padding: 20px;
Â  Â  Â  z-index: 1001;
Â  Â  Â  min-width: 320px;
Â  Â  Â  display: none;
Â  Â  }
Â  Â  #settingsPanel h2 {
Â  Â  Â  margin-top: 0;
Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  font-size: 1.2rem;
Â  Â  }
Â  Â  .column-setting {
Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  }
Â  Â  .column-setting label {
Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  margin-bottom: 3px;
Â  Â  }
Â  Â  .settings-actions {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: flex-end;
Â  Â  Â  gap: 10px;
Â  Â  Â  margin-top: 15px;
Â  Â  }
Â  Â  #settingsBtn {
Â  Â  Â  width: 2.1rem;
Â  Â  Â  height: 2.1rem;
Â  Â  Â  padding: 0;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  font-size: 1.1rem;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  background-color: transparent;
Â  Â  Â  border: 2px solid var(--control-bg);
Â  Â  Â  color: var(--control-bg);
Â  Â  Â  margin-left: 5px;
Â  Â  }
Â  Â  #settingsBtn:hover {
Â  Â  Â  background-color: var(--control-bg);
Â  Â  Â  color: var(--button-text-color);
Â  Â  }

Â  Â  /* Count information in the tier header */
Â  Â  .counts {
Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  opacity: 0.8;
Â  Â  }

Â  Â  /* Button to remove a tier */
Â  Â  .remove-tier {
Â  Â  Â  background: none;
Â  Â  Â  border: none;
Â  Â  Â  color: inherit;
Â  Â  Â  font-weight: bold;
Â  Â  Â  cursor: pointer;
Â  Â  Â  align-self: flex-end;
Â  Â  Â  padding: 0;
Â  Â  }

Â  Â  /* Duplicate warning */
Â  Â  #duplicateMsg {
Â  Â  Â  background-color: #f8d7da;
Â  Â  Â  color: #721c24;
Â  Â  Â  border: 1px solid #f5c6cb;
Â  Â  Â  padding: 4px 8px;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  white-space: nowrap;
Â  Â  Â  font-size: 0.85rem;
Â  Â  Â  pointer-events: none;
Â  Â  Â  z-index: 1000;
Â  Â  }

Â  Â  /* Responsive adjustments */
Â  Â  @media (max-width: 600px) {
Â  Â  Â  :root {
Â  Â  Â  Â  --header-width: 100px;
Â  Â  Â  }
Â  Â  Â  .controls input[type="text"] {
Â  Â  Â  Â  flex-basis: 100%;
Â  Â  Â  }
Â  Â  }

Â  Â  /* Print-friendly style: hide controls and trash bin */
Â  Â  @media print {
Â  Â  Â  .controls,
Â  Â  Â  #trashBin,
Â  Â  Â  #settingsOverlay,
Â  Â  Â  #settingsPanel,
Â  Â  Â  #duplicateMsg {
Â  Â  Â  Â  display: none !important;
Â  Â  Â  }
Â  Â  Â  body {
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  padding: 0;
Â  Â  Â  }
Â  Â  }
Â  </style>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
Â  Â  <div class="container">
Â  Â  Â  Â  <h1 id="pageTitle" contenteditable="true" spellcheck="false">Simple Tier List</h1>
Â  Â  <div class="controls">
Â  Â  Â  Â  Â  Â  <input type="text" id="bulkTitles" placeholder="Add title(s) â€¦ (separate with | or ;)" style="flex-grow:1;" />
Â  Â  Â  <button id="addBulkBtn">Add</button>
Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <input type="file" id="fileInput" accept=".txt,.csv,.xls,.xlsx" style="display:none" />
Â  Â  Â  <button id="importBtn">Import file</button>

Â  Â  Â  <button id="addTierBtn">Add tier</button>
Â  Â  Â  Â  Â  Â  <button id="themeToggle" title="Toggle theme">ðŸŒ™</button>
Â  Â  Â  Â  Â  Â  <button id="settingsBtn" title="Settings">âš™</button>
Â  Â  </div>

Â  Â  Â  Â  <div id="duplicateMsg" style="display:none; position: absolute;"></div>

Â  Â  Â  Â  <div class="controls" style="margin-top: 5px;">
Â  Â  Â  <button id="sortUnrankedBtn">Sort unranked (Aâ€“Z)</button>
Â  Â  Â  <button id="shuffleUnrankedBtn">Shuffle unranked</button>
Â  Â  </div>
Â  Â  <div id="tiers">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="controls" id="bottomControls" style="margin-top: 10px;">
Â  Â  Â  <button id="saveBtn">Save layout</button>
Â  Â  Â  <button id="resetBtn">Reset</button>
Â  Â  Â  <button id="exportJsonBtn">Export JSON</button>
Â  Â  Â  <input type="file" id="importJsonInput" accept=".json" style="display:none" />
Â  Â  Â  <button id="importJsonBtn">Import JSON</button>
Â  Â  Â  Â  Â  Â  <button id="exportImageBtn">Export image</button>
Â  Â  </div>

Â  Â  Â  Â  <div id="trashBin" title="Drag items here to delete">ðŸ—‘ Delete</div>

Â  Â  Â  Â  <div id="settingsOverlay"></div>
Â  Â  <div id="settingsPanel">
Â  Â  Â  <h2>Column Settings</h2>
Â  Â  Â  Â  Â  Â  <div id="columnSettingsContainer"></div>
Â  Â  Â  <div class="settings-actions">
Â  Â  Â  Â  <button id="cancelSettingsBtn">Cancel</button>
Â  Â  Â  Â  <button id="saveSettingsBtn">Save</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  /*
Â  Â  Â  JavaScript for controlling the tier list. The following functions are supported:
Â  Â  Â  Â  â€“ Create default tiers (S, A, B, C, D, Unranked) with color.
Â  Â  Â  Â  â€“ Dynamically edit the name and color for each tier.
Â  Â  Â  Â  â€“ Add new items that can be dragged and dropped between tiers.
Â  Â  Â  Â  â€“ Drag-and-drop with HTML5 API for both reordering within the same tier and moving between tiers.
Â  Â  Â  Â  â€“ Save and load layout from the browser's localStorage.
Â  Â  Â  Â  â€“ Reset to default.
Â  Â  */

Â  Â  // Define default tiers. Use a list of objects containing name, color, and an empty list for items.
Â  Â  const defaultTiers = [
Â  Â  Â  { name: 'S', color: '#f94144', items: [] },
Â  Â  Â  { name: 'A', color: '#f3722c', items: [] },
Â  Â  Â  { name: 'B', color: '#f9844a', items: [] },
Â  Â  Â  { name: 'C', color: '#f8961e', items: [] },
Â  Â  Â  { name: 'D', color: '#f9c74f', items: [] },
Â  Â  Â  { name: 'Unranked', color: '#90be6d', items: [] }
Â  Â  ];

Â  Â  // Global state for tiers and next item ID
Â  Â  let tiers = [];
Â  Â  let nextItemId = 1;

Â  Â  // Column settings: an array of up to 6 objects { label, showHover, showPermanent }.
Â  Â  // These are used to determine how extra columns are displayed in tooltips and permanently on the items.
Â  Â  let columnSettings = [];
Â  Â  // Maximum number of extra columns (from Excel column B to G)
Â  Â  const MAX_EXTRA_COLS = 6;

Â  Â  // Global variables for drag-and-drop. Used to move items between tiers.
Â  Â  // When an item begins to be dragged, currentDraggedEl is set to the element.
Â  Â  // This means we don't have to rely on dataTransfer to retrieve the ID on drop.
Â  Â  let currentDraggedEl = null;

Â  Â  // Flag indicating if an element was deleted in the trash-drop handler. Used to prevent reversal in dragend.
Â  Â  let wasDeleted = false;

Â  Â  /**
Â  Â  Â * Calculate contrast color (black or white) based on background color.
Â  Â  Â * @param {string} hex â€“ Color in the format #rrggbb
Â  Â  Â * @returns {string} '#000000' or '#ffffff'
Â  Â  Â */
Â  Â  function getContrastColor(hex) {
Â  Â  Â  // Remove # if present
Â  Â  Â  hex = hex.replace('#', '');
Â  Â  Â  if (hex.length === 3) {
Â  Â  Â  Â  hex = hex.split('').map(c => c + c).join('');
Â  Â  Â  }
Â  Â  Â  const r = parseInt(hex.substr(0, 2), 16);
Â  Â  Â  const g = parseInt(hex.substr(2, 2), 16);
Â  Â  Â  const b = parseInt(hex.substr(4, 2), 16);
Â  Â  Â  // Calculate luminance according to the YIQ formula
Â  Â  Â  const yiq = (r * 299 + g * 587 + b * 114) / 1000;
Â  Â  Â  return yiq >= 128 ? '#000000' : '#ffffff';
Â  Â  }

Â  Â  /**
Â  Â  Â * Lighten a hex color by a percentage. Used for the progress bar.
Â  Â  Â * @param {string} hex Color in format #rrggbb
Â  Â  Â * @param {number} percent Percentage to lighten (0â€“1)
Â  Â  Â * @returns {string} New hex color
Â  Â  Â */
Â  Â  function lightenColor(hex, percent) {
Â  Â  Â  hex = hex.replace('#', '');
Â  Â  Â  if (hex.length === 3) {
Â  Â  Â  Â  hex = hex.split('').map(c => c + c).join('');
Â  Â  Â  }
Â  Â  Â  let r = parseInt(hex.substr(0, 2), 16);
Â  Â  Â  let g = parseInt(hex.substr(2, 2), 16);
Â  Â  Â  let b = parseInt(hex.substr(4, 2), 16);
Â  Â  Â  r = Math.round(r + (255 - r) * percent);
Â  Â  Â  g = Math.round(g + (255 - g) * percent);
Â  Â  Â  b = Math.round(b + (255 - b) * percent);
Â  Â  Â  return '#' + r.toString(16).padStart(2, '0') +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â g.toString(16).padStart(2, '0') +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â b.toString(16).padStart(2, '0');
Â  Â  }

Â  Â  /**
Â  Â  Â * Convert a text to title case (first letter of each word is capitalized).
Â  Â  Â * Words are separated by spaces. If the text contains hyphens or other
Â  Â  Â * separators, each part is treated separately. If you want to keep existing
Â  Â  Â * capital letters within words, you must adjust this function.
Â  Â  Â * @param {string} str
Â  Â  Â * @returns {string}
Â  Â  Â */
Â  Â  function toTitleCase(str) {
Â  Â  Â  return str.trim()
Â  Â  Â  Â  .split(/\s+/)
Â  Â  Â  Â  .map(word => {
Â  Â  Â  Â  Â  if (!word) return '';
Â  Â  Â  Â  Â  const first = word[0].toUpperCase();
Â  Â  Â  Â  Â  const rest = word.slice(1).toLowerCase();
Â  Â  Â  Â  Â  return first + rest;
Â  Â  Â  Â  })
Â  Â  Â  Â  .join(' ');
Â  Â  }

Â  Â  // Page title is also saved in localStorage
Â  Â  let pageTitle = 'Simple Tier List';

Â  Â  /**
Â  Â  Â * Load column settings from localStorage or use default values.
Â  Â  Â */
Â  Â  function loadColumnSettings() {
Â  Â  Â  try {
Â  Â  Â  Â  const saved = localStorage.getItem('tierColumnSettings');
Â  Â  Â  Â  if (saved) {
Â  Â  Â  Â  Â  const arr = JSON.parse(saved);
Â  Â  Â  Â  Â  if (Array.isArray(arr) && arr.length === MAX_EXTRA_COLS) {
Â  Â  Â  Â  Â  Â  columnSettings = arr;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.warn('Could not read column settings from localStorage', e);
Â  Â  Â  }
Â  Â  Â  // If no saved settings, set defaults
Â  Â  Â  columnSettings = [];
Â  Â  Â  for (let i = 0; i < MAX_EXTRA_COLS; i++) {
Â  Â  Â  Â  // Default name based on the alphabet (B, C, D, E, F, G)
Â  Â  Â  Â  const colName = String.fromCharCode(66 + i);
Â  Â  Â  Â  columnSettings.push({ label: `Col ${colName}`, showHover: true, showPermanent: false });
Â  Â  Â  }
Â  Â  }

Â  Â  /**
Â  Â  Â * Save column settings to localStorage
Â  Â  Â */
Â  Â  function saveColumnSettings() {
Â  Â  Â  try {
Â  Â  Â  Â  localStorage.setItem('tierColumnSettings', JSON.stringify(columnSettings));
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.warn('Could not save column settings', e);
Â  Â  Â  }
Â  Â  }

Â  Â  /**
Â  Â  Â * Apply column settings to all existing items.
Â  Â  Â */
Â  Â  function applySettingsToAllItems() {
Â  Â  Â  const itemEls = document.querySelectorAll('.item');
Â  Â  Â  itemEls.forEach(el => {
Â  Â  Â  Â  const obj = findItemById(el.id);
Â  Â  Â  Â  if (obj) {
Â  Â  Â  Â  Â  applySettingsToItem(el, obj);
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  /**
Â  Â  Â * Apply column settings to a single item.
Â  Â  Â * @param {HTMLElement} el â€“ DOM element for the item
Â  Â  Â * @param {Object} item â€“ Object with text and extra fields
Â  Â  Â */
Â  Â  function applySettingsToItem(el, item) {
Â  Â  Â  // Get extra fields as an array (can be undefined)
Â  Â  Â  const extraArr = Array.isArray(item.extra) ? item.extra : [];
Â  Â  Â  // Build tooltip
Â  Â  Â  const hoverParts = [];
Â  Â  Â  // Title (always included first)
Â  Â  Â  hoverParts.push(item.text);
Â  Â  Â  for (let i = 0; i < MAX_EXTRA_COLS; i++) {
Â  Â  Â  Â  const value = extraArr[i];
Â  Â  Â  Â  if (value !== undefined && value !== null && String(value).trim()) {
Â  Â  Â  Â  Â  const cfg = columnSettings[i] || { label: `Col ${String.fromCharCode(66 + i)}`, showHover: true, showPermanent: false };
Â  Â  Â  Â  Â  if (cfg.showHover) {
Â  Â  Â  Â  Â  Â  hoverParts.push(`${cfg.label} - ${String(value).trim()}`);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  el.title = hoverParts.join(', ');
Â  Â  Â  // Remove existing permanent extra fields container if it exists
Â  Â  Â  const existing = el.querySelector('.extra-fields');
Â  Â  Â  if (existing) existing.remove();
Â  Â  Â  const permanentParts = [];
Â  Â  Â  for (let i = 0; i < MAX_EXTRA_COLS; i++) {
Â  Â  Â  Â  const value = extraArr[i];
Â  Â  Â  Â  if (value !== undefined && value !== null && String(value).trim()) {
Â  Â  Â  Â  Â  const cfg = columnSettings[i] || { label: `Col ${String.fromCharCode(66 + i)}`, showHover: true, showPermanent: false };
Â  Â  Â  Â  Â  if (cfg.showPermanent) {
Â  Â  Â  Â  Â  Â  permanentParts.push({ label: cfg.label, value: String(value).trim() });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  if (permanentParts.length > 0) {
Â  Â  Â  Â  const container = document.createElement('div');
Â  Â  Â  Â  container.className = 'extra-fields';
Â  Â  Â  Â  permanentParts.forEach(part => {
Â  Â  Â  Â  Â  const span = document.createElement('span');
Â  Â  Â  Â  Â  span.textContent = `${part.label} - ${part.value}`;
Â  Â  Â  Â  Â  container.appendChild(span);
Â  Â  Â  Â  });
Â  Â  Â  Â  el.appendChild(container);
Â  Â  Â  }
Â  Â  }

Â  Â  /**
Â  Â  Â * Generate a unique ID for a new item.
Â  Â  Â */
Â  Â  function generateItemId() {
Â  Â  Â  return 'item-' + nextItemId++;
Â  Â  }

Â  Â  /**
Â  Â  Â * Create the DOM for a tier and its items. Returns a DOM element.
Â  Â  Â * @param {Object} tierObj â€“ The tier to be displayed.
Â  Â  Â * @param {number} tierIndex â€“ The index in the tiers array.
Â  Â  Â */
Â  Â  function createTierElement(tierObj, tierIndex, totalCount) {
Â  Â  Â  const tier = document.createElement('div');
Â  Â  Â  tier.className = 'tier';

Â  Â  Â  // Header for tier (name, progress and footer)
Â  Â  Â  const header = document.createElement('div');
Â  Â  Â  header.className = 'tier-header';
Â  Â  Â  header.style.backgroundColor = tierObj.color;
Â  Â  Â  const contrastColor = getContrastColor(tierObj.color);
Â  Â  Â  header.style.color = contrastColor;

Â  Â  Â  // Prevent drop on header and name field
Â  Â  Â  header.addEventListener('dragover', (ev) => {
Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  });
Â  Â  Â  header.addEventListener('drop', (ev) => {
Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  });

Â  Â  Â  // Top: name field
Â  Â  Â  const nameInput = document.createElement('input');
Â  Â  Â  nameInput.type = 'text';
Â  Â  Â  nameInput.value = tierObj.name;
Â  Â  Â  nameInput.title = 'Change tier name';
Â  Â  Â  nameInput.addEventListener('input', () => {
Â  Â  Â  Â  tierObj.name = nameInput.value;
Â  Â  Â  });
Â  Â  Â  // Prevent drag/drop from putting data into the name field
Â  Â  Â  ['dragover', 'drop'].forEach(evtName => {
Â  Â  Â  Â  nameInput.addEventListener(evtName, (ev) => {
Â  Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  Â  header.appendChild(nameInput);

Â  Â  Â  // Middle: progress bar
Â  Â  Â  const progressContainer = document.createElement('div');
Â  Â  Â  progressContainer.className = 'progress-container';
Â  Â  Â  const progressBar = document.createElement('div');
Â  Â  Â  progressBar.className = 'progress-bar';
Â  Â  Â  // Calculate percentage of items in this tier
Â  Â  Â  const tierCount = tierObj.items.length;
Â  Â  Â  const denom = totalCount || 0;
Â  Â  Â  let percent = 0;
Â  Â  Â  if (denom > 0) percent = Math.round((tierCount / denom) * 100);
Â  Â  Â  progressBar.style.width = `${percent}%`;
Â  Â  Â  // Lighten the color slightly for the progress bar
Â  Â  Â  // Use a stronger lightening to make the progress more visible
Â  Â  Â  progressBar.style.backgroundColor = lightenColor(tierObj.color, 0.7);
Â  Â  Â  progressContainer.appendChild(progressBar);
Â  Â  Â  header.appendChild(progressContainer);

Â  Â  Â  // Bottom: footer with counts, percentage, color picker, and remove button
Â  Â  Â  const footer = document.createElement('div');
Â  Â  Â  footer.className = 'tier-footer';
Â  Â  Â  // Count info (displayed in parentheses)
Â  Â  Â  const countSpan = document.createElement('span');
Â  Â  Â  countSpan.className = 'count-info';
Â  Â  Â  countSpan.textContent = `(${tierCount}/${denom}),`;
Â  Â  Â  // Percentage info
Â  Â  Â  const percentSpan = document.createElement('span');
Â  Â  Â  percentSpan.className = 'percent-info';
Â  Â  Â  percentSpan.textContent = denom > 0 ? `${percent}%` : '0%';
Â  Â  Â  // Color picker (small)
Â  Â  Â  const colorInput = document.createElement('input');
Â  Â  Â  colorInput.type = 'color';
Â  Â  Â  colorInput.value = tierObj.color;
Â  Â  Â  colorInput.title = 'Select tier color';
Â  Â  Â  // On color change: update background, contrast, progress bar, and text colors
Â  Â  Â  colorInput.addEventListener('input', () => {
Â  Â  Â  Â  tierObj.color = colorInput.value;
Â  Â  Â  Â  // Update background color
Â  Â  Â  Â  header.style.backgroundColor = tierObj.color;
Â  Â  Â  Â  // Update progress bar color with lightening
Â  Â  Â  Â  progressBar.style.backgroundColor = lightenColor(tierObj.color, 0.7);
Â  Â  Â  Â  // Update contrast color
Â  Â  Â  Â  const newContrast = getContrastColor(tierObj.color);
Â  Â  Â  Â  header.style.color = newContrast;
Â  Â  Â  Â  countSpan.style.color = newContrast;
Â  Â  Â  Â  percentSpan.style.color = newContrast;
Â  Â  Â  Â  removeBtn && (removeBtn.style.color = newContrast);
Â  Â  Â  });
Â  Â  Â  // Prevent drag from being dropped on the color picker
Â  Â  Â  ['dragover', 'drop'].forEach(evtName => {
Â  Â  Â  Â  colorInput.addEventListener(evtName, (ev) => {
Â  Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  });
Â  Â  Â  });

Â  Â  Â  // Remove button (only if not unranked)
Â  Â  Â  let removeBtn = null;
Â  Â  Â  if (tierIndex < tiers.length - 1) {
Â  Â  Â  Â  removeBtn = document.createElement('button');
Â  Â  Â  Â  removeBtn.className = 'remove-tier';
Â  Â  Â  Â  removeBtn.textContent = 'Ã—';
Â  Â  Â  Â  removeBtn.title = 'Remove this tier';
Â  Â  Â  Â  removeBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  removeTier(tierIndex);
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  // Set text colors in the footer for contrast
Â  Â  Â  countSpan.style.color = contrastColor;
Â  Â  Â  percentSpan.style.color = contrastColor;
Â  Â  Â  // Add elements to footer
Â  Â  Â  footer.appendChild(countSpan);
Â  Â  Â  footer.appendChild(percentSpan);
Â  Â  Â  footer.appendChild(colorInput);
Â  Â  Â  if (removeBtn) footer.appendChild(removeBtn);

Â  Â  Â  header.appendChild(footer);

Â  Â  Â  // Item container
Â  Â  Â  const itemsContainer = document.createElement('div');
Â  Â  Â  itemsContainer.className = 'tier-items';
Â  Â  Â  itemsContainer.dataset.tierIndex = tierIndex;
Â  Â  Â  // Dragover event allows drop
Â  Â  Â  itemsContainer.addEventListener('dragover', (ev) => {
Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  // Show that we allow moving
Â  Â  Â  Â  if (ev.dataTransfer) {
Â  Â  Â  Â  Â  ev.dataTransfer.dropEffect = 'move';
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  itemsContainer.addEventListener('dragenter', (ev) => {
Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  itemsContainer.classList.add('drag-over');
Â  Â  Â  });
Â  Â  Â  itemsContainer.addEventListener('dragleave', () => {
Â  Â  Â  Â  itemsContainer.classList.remove('drag-over');
Â  Â  Â  });
Â  Â  Â  itemsContainer.addEventListener('drop', (ev) => {
Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  // Stop bubbling to prevent other drop handlers from running
Â  Â  Â  Â  ev.stopPropagation();
Â  Â  Â  Â  const draggedEl = currentDraggedEl;
Â  Â  Â  Â  if (draggedEl) {
Â  Â  Â  Â  Â  // Remove highlighting class from all containers
Â  Â  Â  Â  Â  const allContainers = document.querySelectorAll('.tier-items');
Â  Â  Â  Â  Â  allContainers.forEach(c => c.classList.remove('drag-over'));
Â  Â  Â  Â  Â  // Add the element to this container (automatically moves from its previous container)
Â  Â  Â  Â  Â  itemsContainer.appendChild(draggedEl);
Â  Â  Â  Â  Â  // Do not update the data model here; it is done in dragend to avoid duplication.
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // Add existing items to itemsContainer
Â  Â  Â  tierObj.items.forEach(item => {
Â  Â  Â  Â  const itemEl = createItemElement(item);
Â  Â  Â  Â  itemsContainer.appendChild(itemEl);
Â  Â  Â  });

Â  Â  Â  tier.appendChild(header);
Â  Â  Â  tier.appendChild(itemsContainer);
Â  Â  Â  return tier;
Â  Â  }

Â  Â  /**
Â  Â  Â * Create a DOM element for an item.
Â  Â  Â * @param {Object} item â€“ Object with ID and text.
Â  Â  Â */
Â  Â  function createItemElement(item) {
Â  Â  Â  const el = document.createElement('div');
Â  Â  Â  el.className = 'item';
Â  Â  Â  el.id = item.id;
Â  Â  Â  // Store a reference to the item object on the DOM element for later use when reordering
Â  Â  Â  el._item = item;
Â  Â  Â  el.textContent = item.text;
Â  Â  Â  // Tooltip and extra fields are handled via applySettingsToItem
Â  Â  Â  el.draggable = true;
Â  Â  Â  el.addEventListener('dragstart', (ev) => {
Â  Â  Â  Â  // Store reference to the dragged element globally
Â  Â  Â  Â  currentDraggedEl = el;
Â  Â  Â  Â  // Also set dataTransfer for compatibility, but do not rely on it
Â  Â  Â  Â  ev.dataTransfer.setData('text/plain', el.id);
Â  Â  Â  Â  ev.dataTransfer.effectAllowed = 'move';
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  el.classList.add('dragging');
Â  Â  Â  Â  }, 0);
Â  Â  Â  Â  // Store original parent to be able to move back if dropped in an invalid area
Â  Â  Â  Â  el._originalParent = el.parentElement;
Â  Â  Â  });
Â  Â  Â  el.addEventListener('dragend', () => {
Â  Â  Â  Â  el.classList.remove('dragging');
Â  Â  Â  Â  // After dragging ends, update the data model and the counts/progress.
Â  Â  Â  Â  // This also captures cases where the drop occurs outside a valid container.
Â  Â  Â  Â  // If the element was deleted in the trash-drop handler, prevent reversal and reset the flag
Â  Â  Â  Â  if (!wasDeleted) {
Â  Â  Â  Â  Â  // If the element is no longer in a tier-items container or the trash bin, move it back to the original container
Â  Â  Â  Â  Â  const parent = el.parentElement;
Â  Â  Â  Â  Â  const trash = document.getElementById('trashBin');
Â  Â  Â  Â  Â  if (!parent || (!parent.classList.contains('tier-items') && parent !== trash)) {
Â  Â  Â  Â  Â  Â  if (el._originalParent) {
Â  Â  Â  Â  Â  Â  Â  el._originalParent.appendChild(el);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  // In any case, update data model and counts/progress
Â  Â  Â  Â  updateDataFromDOM();
Â  Â  Â  Â  updateCountsAndProgress();
Â  Â  Â  Â  // Reset flag and global variable
Â  Â  Â  Â  wasDeleted = false;
Â  Â  Â  Â  currentDraggedEl = null;
Â  Â  Â  });
Â  Â  Â  // Allow reordering by dropping on another element
Â  Â  Â  el.addEventListener('dragover', (ev) => {
Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  if (ev.dataTransfer) {
Â  Â  Â  Â  Â  ev.dataTransfer.dropEffect = 'move';
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  el.addEventListener('drop', (ev) => {
Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  // Stop bubbling so the container does not also handle the drop (prevents the element from being moved twice)
Â  Â  Â  Â  ev.stopPropagation();
Â  Â  Â  Â  // Get the dragged element from the global variable
Â  Â  Â  Â  const draggedEl = currentDraggedEl;
Â  Â  Â  Â  if (!draggedEl || draggedEl === el) return;
Â  Â  Â  Â  // Move the element before this element
Â  Â  Â  Â  el.parentElement.insertBefore(draggedEl, el);
Â  Â  Â  Â  // Do not update the data model here; it is done in dragend.
Â  Â  Â  });
Â  Â  Â  // Apply column settings to this element
Â  Â  Â  applySettingsToItem(el, item);
Â  Â  Â  return el;
Â  Â  }

Â  Â  /**
Â  Â  Â * Render all tiers in the DOM based on the global "tiers" variable.
Â  Â  Â */
Â  Â  function renderTiers() {
Â  Â  Â  const tiersContainer = document.getElementById('tiers');
Â  Â  Â  tiersContainer.innerHTML = '';
Â  Â  Â  // Calculate the total number of items across all tiers
Â  Â  Â  const totalCount = tiers.reduce((sum, t) => sum + t.items.length, 0);
Â  Â  Â  tiers.forEach((tierObj, index) => {
Â  Â  Â  Â  const tierEl = createTierElement(tierObj, index, totalCount);
Â  Â  Â  Â  tiersContainer.appendChild(tierEl);
Â  Â  Â  });

Â  Â  Â  // Do not update the page title here; it is controlled by the contenteditable h1
Â  Â  }

Â  Â  /**
Â  Â  Â * Add a new item to the Unranked tier (last tier). Creates item object and DOM element.
Â  Â  Â * @param {string} text â€“ The item text.
Â  Â  Â */
Â  Â  function addNewItem(text, extra = null) {
Â  Â  Â  if (!text.trim()) return;
Â  Â  Â  const id = generateItemId();
Â  Â  Â  const itemObj = { id, text };
Â  Â  Â  if (extra) {
Â  Â  Â  Â  itemObj.extra = extra;
Â  Â  Â  }
Â  Â  Â  // Add to the last tier (Unranked) in the data
Â  Â  Â  tiers[tiers.length - 1].items.push(itemObj);
Â  Â  Â  // Create DOM and add to the last tier
Â  Â  Â  const itemEl = createItemElement(itemObj);
Â  Â  Â  const containers = document.querySelectorAll('.tier-items');
Â  Â  Â  const unrankedContainer = containers[containers.length - 1];
Â  Â  Â  unrankedContainer.appendChild(itemEl);
Â  Â  Â  // Update counts/progress without a full re-render
Â  Â  Â  updateCountsAndProgress();
Â  Â  }

Â  Â  /**
Â  Â  Â * Fetch data from the DOM to update the global "tiers" (names, colors, item order).
Â  Â  Â */
Â  Â  function updateDataFromDOM() {
Â  Â  Â  tiers.forEach((tierObj, tierIndex) => {
Â  Â  Â  Â  // Update name and color
Â  Â  Â  Â  const tierEl = document.querySelectorAll('.tier')[tierIndex];
Â  Â  Â  Â  const nameInput = tierEl.querySelector('.tier-header input[type="text"]');
Â  Â  Â  Â  const colorInput = tierEl.querySelector('.tier-header input[type="color"]')
